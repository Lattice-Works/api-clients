Load and combine data
================
Joke Durnez, updated by Yue Li
9/11/2020

## Loading the api-client

After we’ve installed the R library for the OL-API, we can load the
library, set the basepath and our authentication, and get the client.
Note that the functions are *veeeerry* similar to the python ones. (You
can find you jwt token in the [account
page](https://openlattice.com/gallery/#/edit_account) of your
openlattice account)

``` r
library(openlattice)
library(knitr)
library(httr)
library(magrittr) #for piping
library(purrr) #map_dfr function
library(tibble)
library(dplyr) 
library(tidyr)

jwt <- "***"
```

``` r
basepath <- "https://api.openlattice.com"
header_params <- unlist(list("Authorization" = paste("Bearer", jwt)))

client <- ApiClient$new(
  defaultHeaders = header_params,
  basePath = basepath
)
```

## Loading the APIs

Next, we load the APIs.

``` r
edmApi <- EdmApi$new(apiClient = client)
entitySetsApi <- EntitySetsApi$new(apiClient = client)
dataApi <- DataApi$new(apiClient = client)
searchApi <- SearchApi$new(apiClient = client)
```

## Using basic functions

We now load the entity set IDs and the data. First, decide what data you
want. Let’s say we have integrated data from a sheriff’s office,
supportive housing group, and detox center. We want to look at arrestees
and any housing statuses they’ve given in the past. Use your flight
diagrams to decide upon entity sets and relationships and get their
names: from your OpenLattice integration, you should have a diagram of
the graph data model that your data now resides in. The one for our
healthcare demonstration data is here. [DemoHealth EDM
diagram](https://github.com/Lattice-Works/api-clients/blob/master/examples/pipelines/demohealth.pdf)

We can see that DemoPatients -\> DemoLivesAt -\> DemoHousings gives us
people and any housing status associated with them.

Unfortunately, there’s no autogenerated documentation for the libraries,
but for the specific names of the functions, you can look at the python
documentation.

``` r
get_data <- function(data_id) {
  dataApi$load_entity_set_data(data_id) %>% 
    transpose() %>% 
    as_tibble() %>%
    unnest(everything()) %>% 
    unnest('openlattice.@id')
}

src_id <- entitySetsApi$get_entity_set_id("DemoPatients")
edge_id <- entitySetsApi$get_entity_set_id("DemoLivesAt")
dst_id <- entitySetsApi$get_entity_set_id("DemoHousings")

src_data <- get_data(src_id)
edge_data <- get_data(edge_id)
dst_data <- get_data(dst_id)

kable(head(src_data))
```

| nc.PersonEthnicity | nc.PersonBirthDate | nc.SubjectIdentification              | nc.PersonSex | nc.PersonSurName | ol.datasource                                  | nc.PersonGivenName | nc.PersonRace | openlattice.@id                      |
| :----------------- | :----------------- | :------------------------------------ | :----------- | :--------------- | :--------------------------------------------- | :----------------- | :------------ | :----------------------------------- |
| nonhispanic        | 1985-09-22         | 4e9b0f1f-1f0a-4346-adaa-8d9475431e1c  | F            | Miller           | Forest Outpatient Treatment, State Hospital    | Kimberly, Kim      | asian         | 11c20000-0000-0000-8000-000000003242 |
| hispanic           | 1982-03-07         | ffce8c91-9c69-4dd5-b640-fdb8ff815eb15 | M            | Avila Manzano    | Anytown Medical Center, State Hospital         | Jim                | white         | 819f0000-0000-0000-8000-000000015e55 |
| nonhispanic        | 1987-08-07         | 7d780dc3-96a3-4a4d-8abf-2ba0aa1996a1  | M            | Mejia            | Forest Outpatient Treatment                    | Robert             | pacisland     | 33750000-0000-0000-8000-000000016d60 |
| nonhispanic        | 1959-01-02         | ffbfe6e0-51b1-46dd-b7d0-dac25a9e58e9  | F            | Walker           | State Hospital                                 | Christina          | black         | caac0000-0000-0000-8000-0000000032bc |
| nonhispanic        | 1960-11-03         | 2cdd14bc-5a7f-4868-86c1-6b78612f3728  | M            | Beck             | State Hospital , Anytown Rehabilitation Center | Matthew            | white         | 70d20000-0000-0000-8000-00000000328f |
| nonhispanic        | 1979-09-14         | 8cfc9d37-5816-42c5-affa-069360cb3fa8  | M            | Smith            | Health State, Inc., State Hospital             | Justin             | white         | b4120000-0000-0000-8000-000000015ecb |

## Getting the neighbors

To join two entity sets (through an edge/association) we must find the
unique ID that each data point, or entity, has in the three tables: the
source, destination, and association. We call these IDs the neighbors.
First, we can create a filter to find all neigbors between two entity
sets (connected through the edge/association), for a subset of ID’s
(entity keys):

``` r
entkeys = unlist(src_data['openlattice.@id'], use.names = FALSE)
filter = NeighborSearchFilter$new(
  entityKeyIds = entkeys,
  src = src_id,
  dst = dst_id
)
```

Using the filter, we can grab all the neighbors and put them in an edges
table. Here we are renaming the appropriate columns ‘src’ and ‘dst’ for
clarity.

``` r
edges = searchApi$execute_filtered_entity_neighbor_search(src_id, filter)

transform_edges <- function(name, edges){
  neighdetails <- edges[[name]][['neighborDetails']]
  if (dim(neighdetails)[1] == 1){
    newtable <- lapply(neighdetails, as.character)
  } else {
    newtable <- neighdetails %>% sapply(as.character)
  }
  newtable <- newtable %>% as_tibble() %>% select('openlattice.@id')
  names(newtable) <- 'dst'
  newtable['src'] <- name
  return (newtable)
}

edges_table <- names(edges) %>% 
  map_dfr(transform_edges, edges)

kable(head(edges_table))
```

| dst                                  | src                                  |
| :----------------------------------- | :----------------------------------- |
| 34490000-0000-0000-8000-0000000032ee | 11c20000-0000-0000-8000-000000003242 |
| cef20000-0000-0000-8000-0000000032a9 | 11c20000-0000-0000-8000-000000003242 |
| d5000000-0000-0000-8000-000000003234 | 11c20000-0000-0000-8000-000000003242 |
| cef20000-0000-0000-8000-0000000032a9 | 6f940000-0000-0000-8000-00000000321f |
| d5000000-0000-0000-8000-000000003234 | 6f940000-0000-0000-8000-00000000321f |
| d5000000-0000-0000-8000-000000003234 | 9e720000-0000-0000-8000-0000000031ff |

## Merging the Tables

Now that we have the edges\_table, it’s just a matter of left joining
all tables to the edges table.

``` r
joined_table <- 
  edges_table %>% 
  left_join (src_data, by = c(src="openlattice.@id")) %>%
  left_join (dst_data,by=c(dst="openlattice.@id"))

kable(head(joined_table))
```

| dst                                  | src                                  | nc.PersonEthnicity | nc.PersonBirthDate | nc.SubjectIdentification              | nc.PersonSex | nc.PersonSurName | ol.datasource                                                                      | nc.PersonGivenName | nc.PersonRace | ol.id              | ol.type            |
| :----------------------------------- | :----------------------------------- | :----------------- | :----------------- | :------------------------------------ | :----------- | :--------------- | :--------------------------------------------------------------------------------- | :----------------- | :------------ | :----------------- | :----------------- |
| 34490000-0000-0000-8000-0000000032ee | 11c20000-0000-0000-8000-000000003242 | nonhispanic        | 1985-09-22         | 4e9b0f1f-1f0a-4346-adaa-8d9475431e1c  | F            | Miller           | Forest Outpatient Treatment, State Hospital                                        | Kimberly, Kim      | asian         | DEPENDENT LIVING   | DEPENDENT LIVING   |
| cef20000-0000-0000-8000-0000000032a9 | 11c20000-0000-0000-8000-000000003242 | nonhispanic        | 1985-09-22         | 4e9b0f1f-1f0a-4346-adaa-8d9475431e1c  | F            | Miller           | Forest Outpatient Treatment, State Hospital                                        | Kimberly, Kim      | asian         | INDEPENDENT LIVING | INDEPENDENT LIVING |
| d5000000-0000-0000-8000-000000003234 | 11c20000-0000-0000-8000-000000003242 | nonhispanic        | 1985-09-22         | 4e9b0f1f-1f0a-4346-adaa-8d9475431e1c  | F            | Miller           | Forest Outpatient Treatment, State Hospital                                        | Kimberly, Kim      | asian         | HOMELESS           | HOMELESS           |
| cef20000-0000-0000-8000-0000000032a9 | 6f940000-0000-0000-8000-00000000321f | nonhispanic        | 1955-08-19         | ffce8c91-9c69-4dd5-b640-fdb8ff815eb12 | F            | Crosby           | State Hospital , Anytown Rehabilitation Center                                     | Cassandra          | white         | INDEPENDENT LIVING | INDEPENDENT LIVING |
| d5000000-0000-0000-8000-000000003234 | 6f940000-0000-0000-8000-00000000321f | nonhispanic        | 1955-08-19         | ffce8c91-9c69-4dd5-b640-fdb8ff815eb12 | F            | Crosby           | State Hospital , Anytown Rehabilitation Center                                     | Cassandra          | white         | HOMELESS           | HOMELESS           |
| d5000000-0000-0000-8000-000000003234 | 9e720000-0000-0000-8000-0000000031ff | nonhispanic        | 1958-06-21         | a3af0b70-c8ff-47bc-9a4b-e34e31e0960c  | M            | Yoder            | State Hospital , County Methadone Treatment Program, Anytown Rehabilitation Center | Jordan             | white         | HOMELESS           | HOMELESS           |
