---
title: "Load and combine data"
author: "Joke Durnez, updated by Yue Li"
date: "9/11/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading the api-client

After we’ve installed the R library for the OL-API, we can load the library, set the basepath and our authentication, and get the client. Note that the functions are *veeeerry* similar to the python ones. (You can find you jwt token in the [account page](https://openlattice.com/gallery/#/edit_account) of your openlattice account)

```{r, message=FALSE}
library(openlattice)
library(knitr)
library(httr)
library(magrittr) #for piping
library(purrr) #map_dfr function
library(tibble)
library(dplyr) 
library(tidyr)

jwt <- "***"
```

```{r, echo=FALSE}
# change JWT token here
jwt <- "***"
```

```{r}
basepath <- "https://api.openlattice.com"
header_params <- unlist(list("Authorization" = paste("Bearer", jwt)))

client <- ApiClient$new(
  defaultHeaders = header_params,
  basePath = basepath
)
```


## Loading the APIs

Next, we load the APIs.

```{r}
edmApi <- EdmApi$new(apiClient = client)
entitySetsApi <- EntitySetsApi$new(apiClient = client)
dataApi <- DataApi$new(apiClient = client)
searchApi <- SearchApi$new(apiClient = client)
```

## Using basic functions

We now load the entity set IDs and the data. First, decide what data you want. Let’s say we have integrated data from a sheriff’s office, supportive housing group, and detox center. We want to look at arrestees and any housing statuses they’ve given in the past. Use your flight diagrams to decide upon entity sets and relationships and get their names: from your OpenLattice integration, you should have a diagram of the graph data model that your data now resides in. The one for our healthcare demonstration data is here. [DemoHealth EDM diagram](https://github.com/Lattice-Works/api-clients/blob/master/examples/pipelines/demohealth.pdf)

We can see that DemoPatients -> DemoLivesAt -> DemoHousings gives us people and any housing status associated with them. 

Unfortunately, there’s no autogenerated documentation for the libraries, but for the specific names of the functions, you can look at the python documentation.

```{r}
get_data <- function(data_id) {
  dataApi$load_entity_set_data(data_id) %>% 
    transpose() %>% 
    as_tibble() %>%
    unnest(everything()) %>% 
    unnest('openlattice.@id')
}

src_id <- entitySetsApi$get_entity_set_id("DemoPatients")
edge_id <- entitySetsApi$get_entity_set_id("DemoLivesAt")
dst_id <- entitySetsApi$get_entity_set_id("DemoHousings")

src_data <- get_data(src_id)
edge_data <- get_data(edge_id)
dst_data <- get_data(dst_id)

kable(head(src_data))
```

## Getting the neighbors

To join two entity sets (through an edge/association) we must find the unique ID that each data point, or entity, has in the three tables: the source, destination, and association. We call these IDs the neighbors. First, we can create a filter to find all neigbors between two entity sets (connected through the edge/association), for a subset of ID’s (entity keys):

```{r}
entkeys = unlist(src_data['openlattice.@id'], use.names = FALSE)
filter = NeighborSearchFilter$new(
  entityKeyIds = entkeys,
  src = src_id,
  dst = dst_id
)
```

Using the filter, we can grab all the neighbors and put them in an edges table. Here we are renaming the appropriate columns ‘src’ and ‘dst’ for clarity.

```{r}
edges = searchApi$execute_filtered_entity_neighbor_search(src_id, filter)

transform_edges <- function(name, edges){
  neighdetails <- edges[[name]][['neighborDetails']]
  if (dim(neighdetails)[1] == 1){
    newtable <- lapply(neighdetails, as.character)
  } else {
    newtable <- neighdetails %>% sapply(as.character)
  }
  newtable <- newtable %>% as_tibble() %>% select('openlattice.@id')
  names(newtable) <- 'dst'
  newtable['src'] <- name
  return (newtable)
}

edges_table <- names(edges) %>% 
  map_dfr(transform_edges, edges)

kable(head(edges_table))
```

## Merging the Tables

Now that we have the edges_table, it’s just a matter of left joining all tables to the edges table.

```{r}
joined_table <- 
  edges_table %>% 
  left_join (src_data, by = c(src="openlattice.@id")) %>%
  left_join (dst_data,by=c(dst="openlattice.@id"))

kable(head(joined_table))
```

